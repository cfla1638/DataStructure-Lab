# 栈的应用 算数表达式求值

## 实验要求

1. 问题描述：表达式计算是实现程序设计语言的基本问题之一，也是栈的应用的一个典型的例子。本次实验要求设计一个程序，用栈对算术表达式求值。

2. 基本要求：用字符串的形式从终端输入语法正确的、不含变量的整数表达式，以“#”结束。根据教科书给出的运算符的优先级，实现对算术四则混合运算表达式的求值，并仿照教科书的例子测试在求值过程中运算符栈、运算数栈、输入字符和主要操作的变化过程。

3. 选做内容：改写课本的代码，使程序支持以下操作：

   1. 多位整数的运算。

   2. 实数的运算。

   3. 乘方的运算。

   4. 自加、自减的运算。

   5. 运算量是变量，在表达式后面再单独为每个变量赋值。

   6. 显示计算器的图形界面。

      （可选做其中的一项或几项）



## 项目设计

**【项目介绍】**

本项目实现了基本要求和选作内容的（1）多位整数的运算、（2）实数的运算、（3）乘方的运算、（6）显示计算器的图形界面。

 

本项目共分为三个部分：

1. 仿照STL的接口，设计的栈模板

2. 用于表达式求值的Expr类

3. GUI类

 由于本项目使用的图形界面框架是Qt，为了保持编码风格的一致，本项目的表达式求值功能采用面向对象的写法。

 

**【各部分设计】**

1. 栈模板：和STL提供的接口是一样的，内部实现是顺序栈，和课本上相同。

2. Expr类：

   * 类内部存储一个C风格的字符串存储表达式
   * 提供`eval()`函数返回表达式计算的结果
   * 提供一个`Errno`来标记上次调用`eval()`函数出现的错误，提供一个`strErrno()`返回错误信息。

   说明：

   选做内容：（1）多位整数的运算、（2）实数的运算，的实现：

   它们在`eval()`函数中实现，具体的处理方法是使用标准库的`sscanf()`函数读取一个多位整数或实数，接着读取下一个运算符。

   （3）乘方的运算：

   在运算符优先级表上添加了乘方，使其支持乘方运算。

   Expr类支持使用 ^ 和 ** 两种方式。但 ** 会在构造函数中被转换成 ^ 形式，方便eval() 函数的计算。

   运算符优先级：

   |      | +    | -    | *    | /    | （   | ）   | ^    | #    |
   | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
   | +    | >    | >    | <    | <    | <    | >    | <    | >    |
   | -    | >    | >    | <    | <    | <    | >    | <    | >    |
   | *    | >    | >    | >    | >    | <    | >    | <    | >    |
   | /    | >    | >    | >    | >    | <    | >    | <    | >    |
   | （   | <    | <    | <    | <    | <    | =    | <    | err  |
   | ）   | >    | >    | >    | >    | err  | >    | >    | >    |
   | ^    | >    | >    | >    | >    | <    | >    | >    | >    |
   | #    | <    | <    | <    | <    | <    | err  | <    | =    |

3. GUI类(Qt 5.14.2)：`CalculatorDialog`

   计算器的对话框由一个显示数据的标签和若干个输入按钮组成。

   `CalculatorDialog`继承了`QDialog`,它的内部有一个缓冲区，存储用户使用鼠标点击按钮或使用键盘输入的数据，当点击 = 按钮或按下Enter键时，`CalculatorDialog`类就会调用Expr类的接口进行求值，然后根据`Expr`的`Errno`标记，选择显示错误信息还是显示计算结果。

## 总结分析

**【stack模板类】**

这个类的设计是有缺陷的：它使用new来分配一大片内存，由于new将分配内存与初始化结合在一起，初始化时，顺序栈的长度是多少，就会调用多少次构造函数，这会付出很大的开销。所以，这种写法只适用于内置类型。

而本程序均是以内置类型去实例化stack模板，所以，这种简单的写法适合本程序。

## 源代码

栈模板：

`stack.h`

表达式求值类

`expr.h`

`expr.cpp`

GUI类

`calculatordialog.h`

`calculatordialog.cpp`

Qt工程文件：

`Calculator.pro`

主程序

`main.cpp`